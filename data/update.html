<!DOCTYPE html>
<html class="h-100" lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title></title>
    <link
      href="css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
  </head>

  <body class="d-flex flex-column h-100">
    <hr id="ws-state" class="border border-2 opacity-100 mt-0" />
    <main class="flex-shrink-0">
      <div class="container">
        <div class="row">
          <div class="col">
            <div id="hostname" class="display-6 text-center"></div>
            <p id="desc" class="lead text-center">arduino cc1101 receiver</p>
            <div class="d-grid gap-2 col-6 mx-auto">
              <form
                action="/update"
                method="post"
                enctype="multipart/form-data"
              >
                <div>
                  <input
                    type="file"
                    class="form-control"
                    name="file"
                    id="file"
                    required
                  />
                </div>
                <div class="d-grid gap-2 mx-auto mt-2">
                  <input type="submit" class="btn btn-primary" value="Update" />
                </div>
              </form>
              <a href="/reboot" class="btn btn-secondary mb-5">Reboot</a>
              <a href="/" class="btn btn-primary">Back</a>
            </div>
          </div>
        </div>
      </div>
    </main>
    <footer class="footer mt-auto py-2">
      <div class="container text-center text-muted">
        <span id="version"></span>
      </div>
    </footer>
    <script src="js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script>
      var gateway = `ws://${window.location.hostname}/ws`;
      var websocket;

      function initWebSocket() {
        console.log("Trying to open a WebSocket connection...");
        websocket = new WebSocket(gateway);
        websocket.onopen = onOpen;
        websocket.onclose = onClose;
        websocket.onmessage = onMessage;
      }

      function onOpen(event) {
        console.log("Connection opened");
        var element = document.getElementById("ws-state");
        if (element.classList.contains("border-danger")) {
          element.classList.remove("border-danger");
        }
        if (!element.classList.contains("border-success")) {
          element.classList.add("border-success");
        }
      }

      function onClose(event) {
        console.log("Connection closed");
        var element = document.getElementById("ws-state");
        if (element.classList.contains("border-success")) {
          element.classList.remove("border-success");
        }
        if (!element.classList.contains("border-danger")) {
          element.classList.add("border-danger");
        }
        setTimeout(initWebSocket, 2000);
      }

      function onMessage(event) {
        const parsedData = JSON.parse(event.data);
        console.log("JSON: " + event.data);

        // Store references to frequently accessed elements
        const hostnameElement = document.getElementById("hostname");
        const versionElement = document.getElementById("version");

        if (parsedData.hostname) {
          document.querySelector("title").textContent = parsedData.hostname;
          hostnameElement.innerHTML = parsedData.hostname;
        }
        if (parsedData.version) {
          versionElement.innerHTML =
            '<a href="/update.html" class="">' + parsedData.version + "</a>";
        }
      }

      window.addEventListener("load", onLoad);

      function onLoad(event) {
        initWebSocket();
      }
    </script>
  </body>
</html>
